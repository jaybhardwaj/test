<head> 
    <% include ../partials/head %>
  
    <% include ../partials/adminheader %>

    <% include assetheader %>

</head>
  <html lang="en">
  <body>
    <div class="container-fluid secondry-color" style="margin-top:0%;min-height: 400px">
      <div class="row" style="padding-top: 1%">
         <span class="modal-title" style="padding-left:45%;">Assign/Unassign</span>
      </div>
      <div class="row" style="float: left;width: 400px">
     <div class="col-md-4"> Select User : </div>
      <div class="col-md-8"><select id="selector" class="form-text-box"  onchange="getData(1)" >
            <option disabled value="0"selected="">select</option>
              <%for(var i=0;i<users.length;i++){%><option value='<%=users[i].id%>'><%=users[i].Name%></option>
              <%}%>
          </select></div>
      </div>

      <div class="hide"   id="tab1" style="padding-top:3%"> 
      <table class="table" >
        <tr>
          <td>
            <td>
              <label class="form-Label">Hardware Type:</label>
            </td>
            <td>
              <select id="hw" type="dropdown"class="form-text-box" onchange="getList('1',this.value)">
                </select>
            </td>
          </td>
          <td>
            <label class="form-Label">Service Tag:</label>
          </td>
          <td>
            <select id="com" class="form-text-box show">
                </select>
          </td>

          <td>
          <td>
            <label class="form-Label">Software Type:</label>
          </td>
          <td>
            <select id="ac" type="dropdown" class="form-text-box" onchange="getAcc(this.value)"></select>
          </td>
          </td>
        
          <td>
            <label class="form-Label">Licence Key:</label>
          </td>
          <td>
           <select id="acc" class="form-text-box show" onchange="">
                </select>
          </td>
        </tr>
      </table>
       <table class="table table-striped table-bordered table-hover table-condensed">
              <thead id="headi">
                <tr>
                  <th>#</th>
                  <th>Asset</th>
                  <th>Service Tag</th>
                  <th>Assign Date</th>
                  <th>Action</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="bodyi">
                </tbody>
         </table>
        
           
   </div>    
              <!-- <button>Unassign</button> -->
       
        </div>
 

 </body>
 </html>
<!---->
<div class="modal " id="myModalcomp"  role="dialog">
  <div class="modal-dialog" style="display:table;height:95%;">
    <!-- Modal content-->
    <div class="modal-content" id="express2" style="height:200px;width:400px">
      <div class="modal-header" style="background-color:#f05f40;">
        <center><label id="head4" class="modal-title" style="color:white;font-size:8pt;"><b>Select Component</b></label>
        <span  data-dismiss="modal"  class="glyphicon glyphicon-remove" style='float: right; color:black; '></span>
        </center>
      </div>
      <div id="err" class="col-lg-6 col-sm-offset-3"></div>
      <div class="modal-body">
        <div class="form-group">
          <div id='componentiddiv'>
            <table id ='addComptable1' class="table table-striped table-bordered table-hover table-condensed" style="overflow-y:auto;">
            <col width="10"><col width="10"><col width="20">

                <thead id="modalHead">
                  <tr>
                    <th style="width:35%;">Component Name</th>
                    <th style="width:35%">TagNo</th>
                    <th style="width:30%;">Action</th>
                  </tr>
                </thead>
                <tbody id="addcompobody1">
                </tbody>
              </table>
           

            </div>
          </div>
        </div>
    </div>
  </div>
</div>


<!---->
  <footer>
    <% include ../partials/footer %>
  </footer>
  <script>
    $(document).ready(function(){

      $('.trans-img').addClass('active');
      $(".a").click(function () { 
        $(this).fadeTo("fast", .5).removeAttr("href"); 
      });   
    });
    
    $("#acc").editableSelect({
      onSelect:function(elem){
        var count=0;
        var check=false;
        $("#bodyi tr").each(function(i,row){
          count++;
          $(this).find('td').each(function(k,val){
            var flag=false;
              if(k=='1'){
                if($("#ac option:selected").text()==val.text()){
                  flag=true;
                  check=true;
                }
              }
              if(flag==true){
                if(k=='2'){
                  val.text(elem[0].value);
                }
              }
          });
        });
          if(check==false){
            var row='<tr><td>'+ ++count+'</td><td>'+$("#ac option:selected").text()+'</td><td>'+elem[0].value+'</td><td><input class="form-text-box datetimepicker"></input>'+
            '<td><button>Unassign</button></td>';
            $('#bodyi').append(row);
          }
        }
      });
      $("#com").editableSelect({
        onSelect:function(elem){
          alert('onselect');
         /*console.log(elem);
          console.log($("#hw option:selected").text());
          var count=0;
          var check=false;
          $("#bodyi tr").each(function(i,row){
            count++;
            $(this).find('td').each(function(k,val){
              console.log(k);console.log(val);
              var flag=false;
              if(k=='1'){
                if($("#hw option:selected").text()==val.text()){
                  flag=true;
                  check=true;
                }
              }
              if(flag==true){
                if(k=='2'){
                  val.text(elem[0].value);
                }
              }
            });
          });
          if(check==false){
            console.log('elsecheck')
            var row='<tr><td>'+ ++count+'</td><td>'+
            $("#hw option:selected").text()+'</td><td>'+
                elem[0].value+'</td><td><input class="datetimepicker"></input>'+
                '<td><button>Deassign</button></td>';
                $('#bodyi').append(row);
            }*/
        }
      });
     /* $("#selector").editableSelect({
        function selectEmp(elem){
        /*$('li').removeClass('disabled'); 
          $("#as").click(function () { 
            $(this).fadeIn("fast").attr("href", "#tab1"); 
          });
          userid=elem[0].value;
         // console.log(elem[0].value); 
          $.ajax({
            url: "/getUserInfoAsset",
            method:'post',
            data: {qids: elem[0].value},
            dataType: 'json',
            success: function(result){
              //console.log(result);
            }
          });
        }
      });*/






var count=0;
    function addSubline(copId,copName,lineId,tagNo){
    
      console.log(copId,copName,lineId,tagNo);
        var row='<tr><td>'+ ++count+'</td><td>'+copName+'<input type="hidden" id="compId'+ count+'" value='+copId+'></td><td>'+tagNo+'<input type="hidden" id="line'+count+'" value='+lineId+'></td><td><input id="date'+count+'" class="form-text-box date"></input><input  type="hidden" id="tsId'+count+'" value="0"></input>'+'<td><span id="assignreg'+count+'" style="margin-left:70px;color:green; " class="glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"><span  style="margin-left:70px;color:green; " class=" glyphicon glyphicon-tasks" onclick="getsubComponent('+lineId+')"></span></td><td class="hide">0</td>'+'<td id="assign'+count+'" class="">Draft</td>';
                  $('#bodyi').append(row);
                  jQuery('.date').datetimepicker({
                    timepicker:false,
                    format:'Y-m-d'
                  });

    }
     function getData(tid){
      var uid=$("#selector").val();
      userid=uid;
        $('#saveb').removeClass('hide');
        $('#bodyi').html('');
        count=0;
        $.ajax({
          url: "/getTransDetails",
          method:'post',
          data: {atid:tid,uid:uid},
          dataType: 'json',
          success: function(result){
             $("#tab1").removeClass("hide");
            for(var i=0;i<result[0].length;i++){
              var row='<tr><td>'+ ++count+'</td><td>'+result[0][i].componentName+'<input type="hidden" id="compId'+count+'" value='+result[0][i].ACID+'></td><td>'+
                  result[0][i].tagNo+'<input type="hidden" id="line'+count+'" value='+result[0][i].Id+'><input type="hidden" id="tsId'+count+'" value='+result[0][i].tsId+'></td><td><input id="date'+count+'" class="form-text-box date" value="'+((result[0][i].assignDate).toString()).slice(0,10)+'"></input><td><span id="assignapp'+count+'" style="margin-left:70px; color:red; " class="glyphicon glyphicon-remove-circle" onclick="unasigned('+count+')"></span><span id="assignreg'+count+'" style="margin-left:70px;color:green; " class="hide glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"></span><span  style="margin-left:70px; color:green; " class=" glyphicon glyphicon-tasks" onclick="getsubComponent('+result[0][i].Id+')"></span>';
                  if(result[0][i].assign==1){
                   
                  row=row+'<span id="assignreg'+count+'" style="margin-left:70px;color:green; " class="hide glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"></span></td>'
                  
                    $('#assignreg'+count).removeClass('hide');
                    $("#assignapp"+count).addClass('hide');
                  row=row+'<td id="assign'+count+'">assigned</td>';  
                  }else{
                      row=row+'<span id="assignreg'+count+'" style="margin-left:70px;color:green; " class=" glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"></span></td>';
                     $('#assignapp'+count).removeClass('hide');
                     $('#assignreg'+count).addClass('hide');
                   row=row+'<td class="hide">0'+'</td><td id="assign'+count+'">unassigned</td>'; 
                  }
              $('#bodyi').append(row);
            }
            for(var i=0;i<result[1].length;i++){
              //alert(result[1].length);
              var row='<tr><td>'+ ++count+'</td><td>'+result[1][i].componentName+'<input type="hidden" id="compId'+count+'" value='+result[1][i].ACID+'></td><td>'+result[1][i].tagNo+'<input type="hidden" id="line'+count+'" value='+result[1][i].Id+'><input type="hidden" id="tsId'+count+'" value='+result[1][i].tsId+'></td><td><input id="date'+count+'" class="form-text-box date" value="'+((result[1][i].assignDate).toString()).slice(0,10)+'"></input><td>';
                 if(result[1][i].assign==1){
                   row=row+'<span id="assignapp'+count+'" style="margin-left:70px; color:red; " class=" glyphicon glyphicon-remove-circle" onclick="unasigned('+count+')"></span></td>';
                
                  
                    $('#assignreg'+count).removeClass('hide');
                    $("#assignapp"+count).addClass('hide');
                  row=row+'<td id="assign'+count+'">assigned</td>';  
                  }else{
                   row=row+'<span id="assignreg'+count+'" style="margin-left:70px;color:green; " class=" glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"></span></td>';
                     $('#assignapp'+count).removeClass('hide');
                     $('#assignreg'+count).addClass('hide');
                   row=row+'<td class="hide">0'+'</td><td id="assign'+count+'">unassigned</td>'; 
                  }
              $('#bodyi').append(row);
            }
          }
        });
        console.log('else--------');
        if(tid=='1'){ 
          console.log('ifajax');
          console.log(tid);
          $.ajax({
            url: "/getTransComp",
            method:'post',
            data: {atid:tid},
            dataType: 'json',
            success: function(result){
              console.log(result);
              var qwer=JSON.stringify(result[1]);
              var data=JSON.stringify(result[0]);
              var options = $("#hw");
              options.empty();

              $.each(JSON.parse(data), function() {
                console.log(data);
                options.append($("<option />").val(this['id']).text(this['componentName']));
              });
              $('#hw').val(JSON.parse(data)[0].id).trigger('change');        
              var option = $("#ac");
              option.empty();
              option.append($("<option />").val('0').text('select'));
              $.each(JSON.parse(qwer), function() {
                option.append($("<option />").val(this['id']).text(this['componentName']));
              });
            }
          });
        } else
        {
          $.ajax({
            url: "/getTransUnassigned",
            method:'post',
            data: {atid:tid,acid:'0'},
            dataType: 'json',
            success: function(result){
            }
          });
        }
      }

      function getList(tid,value){
       // console.log( 'jai ho shri ram' ,tid,value);
        $.ajax({
          url: "/getTransUnassigned",
          method:'post',
          data: {atid:tid,acid:value},
          dataType: 'json',
          success: function(result){
           // console.log('jai maa',result);
            //alert(result);
            var data=JSON.stringify(result[0]);
            var options = $("#com");
            options.empty();
            $.each(JSON.parse(data), function() {
             // console.log(this['id']);
              options.append($("<option />").val(this['id']).text(this['tagNo']));
            });
            $('#com').editableSelect({
              onSelect:function(elem){
                //console.log('rana',elem[0].value);console.log($(this)[0].value);
                var tag=$(this)[0].value;
                //console.log('jai ho',$("#hw option:selected").text());
                var count=0;
                var check=false;
                $("#bodyi tr").each(function(i,row){
                  count++;
                  var flag=false;
                  $(this).find('td').each(function(k,val){
                    if(k=='1'){
                      if($("#hw option:selected").text()==$(this).text()){
                        flag=true;
                        check=true;
                      }
                    }
                    console.log('flaggg'+flag);
                    console.log('checkkkkkkk'+check);
                    if(flag==true){
                      if(k=='2'){
                        $(this).html(tag);
                      }
                    }
                  });
                });
                if(check==false){
                  console.log('elsecheck')
                  var row='<tr><td>'+ ++count+'</td><td>'+$("#hw option:selected").text()+'<input type="hidden" id="compId'+ count+'" value='+$("#hw option:selected").val()+'></td><td>'+$(this)[0].value+'<input type="hidden" id="line'+count+'" value='+elem[0].value+'></td><td><input id="date'+count+'" class="form-text-box date"></input><input  type="hidden" id="tsId'+count+'" value="0"></input>'+'<td><span id="assignreg'+count+'" style="margin-left:70px; color:green; " class="glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"><span  style="margin-left:70px; color:green; " class=" glyphicon glyphicon-tasks" onclick="getsubComponent('+elem[0].value+')"></span></td><td class="hide">0</td>'+'<td id="assign'+count+'" class="">Draft</td>';
                  $('#bodyi').append(row);
                  jQuery('.date').datetimepicker({
                    timepicker:false,
                    format:'Y-m-d'
                  });
                }
              }
            });
          }
        });
      } 
      function getAcc(value){
        $.ajax({
          url: "/getAccUnassigned",
          method:'post',
          data: {cid:value},
          dataType: 'json',
          success: function(result){
            //console.log(result);
           // alert(result);
            var data=JSON.stringify(result[0]);
            var options = $("#acc");
            options.empty();
            $.each(JSON.parse(data), function() {
              //console.log(data);
              options.append($("<option />").val(this['id']).text(this['tagNo']).attr('value1',this['id']));
            });
          var a;
          $('#acc').editableSelect({
            onSelect:function(elem){
              console.log(elem[0].value);
              var tag=$(this)[0].value;
              //console.log($("#ac option:selected"));
              var count=0;
              var check=false;
              $("#bodyi tr").each(function(i,row){
                count++;
                var flag=false;
                $(this).find('td').each(function(k,val){
                  if(k=='1'){
                    if($("#ac option:selected").text()==$(this).text()){
                      flag=true;
                      check=true;
                    }
                  }
                  console.log('flaggg'+flag);
                  console.log('check-----------'+check);
                  if(flag==true){
                    if(k=='2'){
                      $(this).html(tag);
                    }
                  }
                });
              });
              if(check==false){
                console.log('elsecheck')
                var row='<tr><td>'+ ++count+'</td><td>'+$("#ac option:selected").text()+'<input type="hidden" id="compId'+ count+'" value='+$("#ac option:selected").val()+'></td><td>'+$(this)[0].value+'<input type="hidden" id="line'+count+'" value='+elem[0].value+'><input  type="hidden" id="tsId'+count+'" value="0"></td><td><input id="date'+count+'" class="form-text-box date"></input>'
                +'<td><span id="assignreg'+count+'" style=" margin-left:70px;color:green; " class="glyphicon glyphicon-ok-circle" onclick="save2db('+count+')"></td><td class="hide">'+
                elem[0].value+'</td><td class="hide">'+elem[0].getAttribute("value1")+'</td><td id="assign'+count+'">Draft</td>';
                $('#bodyi').append(row);

                jQuery('.date').datetimepicker({
                  timepicker:false,
                  format:'Y-m-d'
                });
              }
            }
          });
        }
      }); 
    }

   /* function Assign(e){
      if($(e).text()=='Unassign'){
        $(e).text('Assign');
      } else
      {
        $(e).text('Unassign');
      }
    }*/

    function save2db(num){
      var uid,lid,cid,adate,tid;
    uid=userid;
    lid=$('#line'.concat(num)).val();
    cid=$('#compId'.concat(num)).val();
    adate=$('#date'.concat(num)).val();
    tid=$('#tsId'.concat(num)).val();
    aflag=1;
   
    console.log(uid,lid,cid,adate,tid);
      $.ajax({
        url: "/saveAssignment",
        method:'post',
        data: {uid:uid,cid:cid,lid:lid,adate:adate,aflag:aflag,tid:tid},
                dataType: 'json',
        success: function(result){
         $('#tsId'.concat(num)).val(result);
         $('#assign'.concat(num)).html(''); 
         $('#assign'.concat(num)).append('assigned');
          $('#assignapp'.concat(num)).removeClass('hide');
          $('#assignreg'.concat(num)).addClass('hide');
         alert('sucessfully asigned');
        }
      });
    }

     function unasigned(num){
    
      var uid,lid,cid,adate,tid;
    uid=userid;
    lid=$('#line'.concat(num)).val();
    cid=$('#compId'.concat(num)).val();
    adate=$('#date'.concat(num)).val();
    tid=$('#tsId'.concat(num)).val();
    aflag=0;
    console.log(uid,lid,cid,adate,tid);
      $.ajax({
        url: "/saveAssignment",
        method:'post',
        data: {uid:uid,cid:cid,lid:lid,adate:adate,aflag:aflag,tid:tid},
                dataType: 'json',
        success: function(result){
        $('#assign'.concat(num)).html('');  
       $('#assign'.concat(num)).append('unassigned');
       $('#assignreg'.concat(num)).removeClass('hide');
          $('#assignapp'.concat(num)).addClass('hide');
         alert('sucessfully unasigned');
        }
      });
    }

function add(i){
  
}
     function getsubComponent(lineId){
       $("#myModalcomp").modal('show');
      $.ajax({
        url: "/getsubComponent",
        method:'post',
        data: {lineId:lineId},
                dataType: 'json',
        success: function(result){
          
          //alert(result[0].length);
            var coid='';
            var coName='';
            var lid='';
            var tag='';
          for(var i=0;i<result[0].length;i++){
            var comp=' ';
            var coid=result[0][i].ACID;
            var coName=result[0][i].componentName;
            var lid=result[0][i].id;
            var tag=result[0][i].tagNo;
             comp=comp+'<tr><td>'+result[0][i].componentName+'</td><td class="hide">'+result[0][i].id+'</td><td>'+result[0][i].tagNo+'</td><td><span data-dismiss="modal" class=" glyphicon glyphicon-tasks" onclick=addSubline('+coid+',"'+coName+'",'+lid+',"'+tag+'")></span></td></tr>';
             $('#addcompobody1').append(comp);
          }
        
         //alert('sucessfully asigned');
        }
      });
    }

    </script>

  </body>

  </html>