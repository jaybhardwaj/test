<head> 
    <% include ../partials/head %>
  
    <% include ../partials/adminheader %>

    <% include assetheader %>

</head>
  <html lang="en">
  <body>
    <div class="container-fluid" style="margin-top:0%;background-color:antiquewhite">
      <div class="row" style="padding-top: 1%">
        
         <span class="modal-title" style="padding-left:38%;">Assign/Unassign</span>
      </div>
      <div class="row"><!-- <div class="col-offset-1 col-md-2 ">Select user :</div>
      -->
      <div class="col-md-4"> 
        <div class="col-md-2" style="margin-left:-3%"><label>User</label></div> 
        <div class="col-md-10">
          <select id="selector" style="padding:1%">
            <option disabled value="0"selected=""></option>
              <%for(var i=0;i<users.length;i++){%><option value='<%=users[i].id%>'><%=users[i].Name%></option>
              <%}%>
          </select>
        </div>
      </div>
      </div>
      <div class="row">
        <ul class="nav nav-pills nav-stacked col-lg-2">
          <li onclick="getData('1')">
            <a href="#tab1" id="as"class="a" data-toggle="tab" style="color:black">Hardware<span id="span1" class="badge "></span></a>
          </li>
          <li onclick="getData('2')">
            <a href="#tab2" class="a" data-toggle="tab" style="color:black">Software<span id="span2" class="badge "></span></a>
          </li>
          
        </ul>
        <div class="col-lg-1" onclick="getData('4')"></div>
        <div class="tab-content">
          <div class="tab-pane col-lg-9 fade" style="background-color:antiquewhite;"id="tab1">
            <div class="row"style="margin:1%;">
              <div class="col-md-2" style="padding-top:6px;">Type</div>
              <div class="col-md-4">
                <select id="hw" type="dropdown"class="form-control" onchange="getList('1',this.value)">
                </select>
              </div>
              <div class="col-md-2" style="padding-top:6px;">Service Tag</div>
              <div class="col-md-4">
                <select id="com" class="form-control show">
                </select>
              </div>
            </div>
            <div class="row" style="margin:1%;">
              <div class="col-md-2" style="padding-top:6px;">Accessories</div>
              <div class="col-md-4">
                <select id="ac" type="dropdown"class="form-control" onchange="getAcc(this.value)"></select>
              </div>
              <div class="col-md-2" style="padding-top:6px;">Service Tag</div>
              <div class="col-md-4">
                <select id="acc" class="form-control show" onchange="">
                </select>
              </div>
            </div>
          <!-- <div class="row" style="margin:1%;"><div class="col-md-2" style="padding-top:6px;">Assign Date</div><div class="col-md-4"><input class="form-control datetimepicker"></input></div>
          <div class="col-md-6"></div></div> -->
          <div class="row" style="margin:1%;">
            <table class="table table-striped table-bordered table-hover table-condensed">
              <thead id="headi">
                <tr>
                  <th>#</th>
                  <th>Asset</th>
                  <th>Service Tag</th>
                  <th>Assign Date</th>
                  <th>Unassign</th>
                </tr>
              </thead>
              <tbody id="bodyi">
                </tbody>
            </table>
          </div>    
              <!-- <button>Unassign</button> -->
        </div>
        <div class="tab-pane fade col-lg-9" id="tab2">
          <div class="row"style="margin:1%;">
            <div class="col-md-2" style="padding-top:6px;">Type</div>
            <div class="col-md-4">
              <select id="hw" type="dropdown"class="form-control" onchange="getList('1',this.value)">
              </select>
            </div>
            <div class="col-md-2" style="padding-top:6px;">Service Tag</div>
            <div class="col-md-4">
              <select id="com" class="form-control show">
              </select>
            </div>
          </div>          
        </div>

        <div class="tab-pane fade col-lg-9" id="tab3">
            
          </div>
        <div class="tab-pane fade col-lg-9" id="tab4">
            
          </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-5"></div>
      <div class="col-md-7">
        <button type="submit" onclick="save2db()"id="saveb"style="margin-left:33%;margin-top:2%;margin-bottom:2%;" class="btn btn-primary hide">Save</button>
      </div>
    </div>
  </div>     
  <footer>
    <% include ../partials/footer %>
  </footer>
  <script>
    $(document).ready(function(){
      $(".a").click(function () { 
        $(this).fadeTo("fast", .5).removeAttr("href"); 
      });   
    });
    
    $("#acc").editableSelect({
      onSelect:function(elem){
        var count=0;
        var check=false;
        $("#bodyi tr").each(function(i,row){
          count++;
          $(this).find('td').each(function(k,val){
            var flag=false;
              if(k=='1'){
                if($("#ac option:selected").text()==val.text()){
                  flag=true;
                  check=true;
                }
              }
              if(flag==true){
                if(k=='2'){
                  val.text(elem[0].value);
                }
              }
          });
        });
          if(check==false){
            var row='<tr><td>'+ ++count+'</td><td>'+$("#ac option:selected").text()+'</td><td>'+elem[0].value+'</td><td><input class="form-control datetimepicker"></input>'+
            '<td><button>Unassign</button></td>';
            $('#bodyi').append(row);
          }
        }
      });
      $("#com").editableSelect({
        onSelect:function(elem){
          alert('onselect');
         /*console.log(elem);
          console.log($("#hw option:selected").text());
          var count=0;
          var check=false;
          $("#bodyi tr").each(function(i,row){
            count++;
            $(this).find('td').each(function(k,val){
              console.log(k);console.log(val);
              var flag=false;
              if(k=='1'){
                if($("#hw option:selected").text()==val.text()){
                  flag=true;
                  check=true;
                }
              }
              if(flag==true){
                if(k=='2'){
                  val.text(elem[0].value);
                }
              }
            });
          });
          if(check==false){
            console.log('elsecheck')
            var row='<tr><td>'+ ++count+'</td><td>'+
            $("#hw option:selected").text()+'</td><td>'+
                elem[0].value+'</td><td><input class="datetimepicker"></input>'+
                '<td><button>Deassign</button></td>';
                $('#bodyi').append(row);
            }*/
        }
      });
      $("#selector").editableSelect({
        onSelect:function(elem){
        /*$('li').removeClass('disabled');*/
          $("#as").click(function () { 
            $(this).fadeIn("fast").attr("href", "#tab1"); 
          });
          userid=elem[0].value;
          console.log(elem[0].value); 
          $.ajax({
            url: "/getUserInfoAsset",
            method:'post',
            data: {qids: elem[0].value},
            dataType: 'json',
            success: function(result){
              console.log(result);
            }
          });
        }
      });
      function getData(tid){
        $('#saveb').removeClass('hide');
        $.ajax({
          url: "/getTransDetails",
          method:'post',
          data: {atid:tid,uid:userid},
          dataType: 'json',
          success: function(result){
            console.log(result[0][0]);
            console.log(result[0].length);
            var count=0;
            for(var i=0;i<result[0].length;i++){
              var row='<tr><td>'+ ++count+'</td><td>'+result[0][i].componentName+'</td><td>'+
                  result[0][i].tagNo+'</td><td><input class="form-control date" value="'+result[0][i].assignDate+'"></input><td><button onclick="Assign(this)">Unassign</button></td><td class="hide">0'+'</td><td class="hide">'+result[0][i].lid+'</td>';
              $('#bodyi').append(row);
            }
            for(var i=0;i<result[1].length;i++){
              var row='<tr><td>'+ ++count+'</td><td>'+result[1][i].attribute+'</td><td>'+result[1][i].tagNo+'</td><td><input class="form-control date" value="'+result[1][i].assignDate+'"></input><td><button onclick="Assign(this)">Unassign</button></td><td class="hide">0'+result[1][i].cid+'</td><td class="hide">'+result[1][i].lid+'</td>';
              $('#bodyi').append(row);
            }
          }
        });
        console.log('else--------');
        if(tid=='1'){ 
          console.log('ifajax');
          console.log(tid);
          $.ajax({
            url: "/getTransComp",
            method:'post',
            data: {atid:tid},
            dataType: 'json',
            success: function(result){
              console.log(result);
              var qwer=JSON.stringify(result[1]);
              var data=JSON.stringify(result[0]);
              var options = $("#hw");
              options.empty();
              $.each(JSON.parse(data), function() {
                console.log(data);
                options.append($("<option />").val(this['id']).text(this['componentName']));
              });
              $('#hw').val(JSON.parse(data)[0].id).trigger('change');        
              var option = $("#ac");
              option.empty();
              $.each(JSON.parse(qwer), function() {
                option.append($("<option />").val(this['id']).text(this['attribute']));
              });
            }
          });
        } else
        {
          $.ajax({
            url: "/getTransUnassigned",
            method:'post',
            data: {atid:tid,acid:'0'},
            dataType: 'json',
            success: function(result){
            }
          });
        }
      }

      function getList(tid,value){
        console.log(tid,value);
        $.ajax({
          url: "/getTransUnassigned",
          method:'post',
          data: {atid:tid,acid:value},
          dataType: 'json',
          success: function(result){
            console.log('jai maa',result);
            alert(result);
            var data=JSON.stringify(result[0]);
            var options = $("#com");
            options.empty();
            $.each(JSON.parse(data), function() {
              console.log(data);
              options.append($("<option />").val(this['id']).text(this['tagNo']));
            });
            $('#com').editableSelect({
              onSelect:function(elem){
                console.log(elem[0]);console.log($(this)[0].value);
                var tag=$(this)[0].value;
                console.log($("#hw option:selected").text());
                var count=0;
                var check=false;
                $("#bodyi tr").each(function(i,row){
                  count++;
                  var flag=false;
                  $(this).find('td').each(function(k,val){
                    if(k=='1'){
                      if($("#hw option:selected").text()==$(this).text()){
                        flag=true;
                        check=true;
                      }
                    }
                    console.log('flaggg'+flag);
                    console.log('checkkkkkkk'+check);
                    if(flag==true){
                      if(k=='2'){
                        $(this).html(tag);
                      }
                    }
                  });
                });
                if(check==false){
                  console.log('elsecheck')
                  var row='<tr><td>'+ ++count+'</td><td>'+$("#hw option:selected").text()+'</td><td>'+$(this)[0].value+'</td><td><input class="form-control date"></input>'+'<td><button onclick="Assign(this)">Unassign</button></td><td class="hide">0</td>'+'<td class="hide">'+$("#hw option:selected").val()+'</td>';
                  $('#bodyi').append(row);
                  jQuery('.date').datetimepicker({
                    timepicker:false,
                    format:'Y-m-d'
                  });
                }
              }
            });
          }
        });
      }
      function getAcc(value){
        $.ajax({
          url: "/getAccUnassigned",
          method:'post',
          data: {cid:value},
          dataType: 'json',
          success: function(result){
            console.log(result);
            alert(result);
            var data=JSON.stringify(result[0]);
            var options = $("#acc");
            options.empty();
            $.each(JSON.parse(data), function() {
              console.log(data);
              options.append($("<option />").val(this['id']).text(this['tagNo']).attr('value1',this['lineId']));
            });
          var a;
          $('#acc').editableSelect({
            onSelect:function(elem){
              console.log(elem[0].getAttribute("value1"));
              var tag=$(this)[0].value;
              console.log($("#ac option:selected"));
              var count=0;
              var check=false;
              $("#bodyi tr").each(function(i,row){
                count++;
                var flag=false;
                $(this).find('td').each(function(k,val){
                  if(k=='1'){
                    if($("#ac option:selected").text()==$(this).text()){
                      flag=true;
                      check=true;
                    }
                  }
                  console.log('flaggg'+flag);
                  console.log('check-----------'+check);
                  if(flag==true){
                    if(k=='2'){
                      $(this).html(tag);
                    }
                  }
                });
              });
              if(check==false){
                console.log('elsecheck')
                var row='<tr><td>'+ ++count+'</td><td>'+$("#ac option:selected").text()+'</td><td>'+$(this)[0].value+'</td><td><input class="form-control date"></input>'
                +'<td><button onclick="Assign(this)">Unassign</button></td><td class="hide">'+
                elem[0].value+'</td><td class="hide">'+elem[0].getAttribute("value1")+'</td>';
                $('#bodyi').append(row);

                jQuery('.date').datetimepicker({
                  timepicker:false,
                  format:'Y-m-d'
                });
              }
            }
          });
        }
      }); 
    }
    
    function Assign(e){
      if($(e).text()=='Unassign'){
        $(e).text('Assign');
      } else
      {
        $(e).text('Unassign');
      }
    }

    function save2db(){
      var uid,lid,cid,adate,tid,aflag='';
      $("#bodyi tr").each(function(i,row){
        $(this).find('td').each(function(k,val){
          if(i=='0'){
            if(k=='0'){
              uid=userid;
            }
            if(k=='1'){
              tid=1;
            }
            if(k=='3'){
              adate=$(this).find('input').val();
            }
            if(k=='4'){
              if($(this).text()=='Unassign'){
                aflag=1;    
              } else
              {
                aflag=0; 
              }  
            }
            if(k=='5'){
              cid=$(this).text();
            }
            if(k=='6'){
              lid=$(this).text();
            }
          } else
          {
            if(k=='0'){
              uid=uid+','+userid;
            }
            if(k=='1'){
              tid=tid+','+1;
            }
            if(k=='3'){
              adate=adate+','+$(this).find('input').val();
            }
            if(k=='4'){
              if($(this).text()=='Unassign'){
                aflag=aflag+','+1;    
              } else
              {
                aflag=aflag+','+0; 
              }
            }
            if(k=='5'){
              cid=cid+','+$(this).text();
            }
            if(k=='6'){
              lid=lid+','+$(this).text();
            }
          }
        });
      });
      console.log(cid,lid,tid,uid,adate,aflag);
      $.ajax({
        url: "/saveAssignment",
        method:'post',
        data: {uid:uid,cid:cid,lid:lid,adate:adate,aflag:aflag,tid:tid},
                dataType: 'json',
        success: function(result){
          console.log('Success');
        }
      });
    }
    </script>

  </body>

  </html>