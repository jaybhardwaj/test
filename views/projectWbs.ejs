<!DOCTYPE html>
<html lang="en">
<% include ./partials/head %> 
        <% include ./partials/adminheader %> 
<body style="overflow-x:hidden"> 
  
<div class="row secondry-color" style="margin:0px;padding:0px;padding-top: 1% ">
<!--  <form method="post" action="/addEditWbsDetails" method="post" class="login-form" id="form1" name="myForm">
 -->           <input type="text" name="wbshidden" class="hide" id="wbshidden" value=2 />
          <input type="text" name="proname" class="hide" id="proname" value='<%=project[0].id%>' />
          <input type="text" name="flaghide" class="hide" id="flaghide" value=0  />
          <input type="text" name="wbsidhide" class="hide" id="idhide" value=0  />
          <!-- <input type="text" name="wbsstatus" class="hide" value=1 id="wbsstatus1"> -->
 
 
<span class="modal-title" style="padding-left:45%;">Add WBS Details</span>
<div class="row" style="padding:3%;padding-top:1%;padding-bottom:1%">
<table class="table" style="margin-bottom:0px">
  <tr>
    <td>
      <td><label class="form-Label" style=" ">WBS Name :<sup>*</sup></label></td>
      <td><input type="text" onfocusout="return allWbs();" onkeypress="return specialCharacter(event)" class="form-text-box" style=" " placeholder="-- Enter a WBS Name --" name="wbsname" id="wbsname" maxlength="25" onfocusout="myFunction(); checkprofield();" value=''></td>
    </td>
    <td>
      <td><label class="form-Label" style=" ">WBS Code :</label> </td>
      <td><input type="text" class="form-text-box" style=" " placeholder="WBS Code" name="wbscode" id="wbscode" maxlength="50" value='' readonly></td>
    </td>
    <td>
      <td><label class="form-Label" style=" ">WBS Owner:</label></td>
      <td>
        <select style=" " class="form-text-box" id="wbsowner" name="wbsowner">
               <option disabled selected value=0>Select</option>
                <% for(var i=0;i<owner.length;i++) {%>
                <option value="<%=owner[i].id%>"><%=owner[i].name%></option>
                <%}%>
        </select>
      </td>
    </td>
    <td>
      <td> <label class="form-Label" style=" ">WBS Location:</label> </td>
      <td><select style=" " class="form-text-box" id="wbslocation" name="wbslocation">
                  <option disabled selected value=0>Select</option>
 
                  <% for(var i=0;i<location.length;i++) {%>
                  <option value="<%=location[i].id%>"><%=location[i].location%></option>
                  <%}%>
        </select></td>
    </td>
  </tr>
    <tr> 
    <td>
      <td><label class="form-Label" style=" ">Planned Start Date: <sup>*</sup> </label> </td>
      <td> <input type="text" class="form-text-box" id="datepicker" maxlength="25" placeholder="Select Planned Start Date" readonly="true" style="cursor: pointer; " name="wbspsdate" value=''></td>
    </td>
    <td>
      <td> <label class="form-Label" style=" ">Planned End Date: <sup>*</sup> </label> </td>
      <td><input type="text" name="wbspedate" class="form-text-box" maxlength="25" placeholder="Select Planned End Date" readonly="true" id="datepicker1" style="cursor: pointer; " value=''></td>
    </td>
    
    <td>
      <td> <label class="form-Label" style=" ">Actual Start Date:</label> </td>
      <td><input type="text" class="form-text-box" id="datepicker2" maxlength="25" style="cursor: pointer;width: 102% " placeholder="Select Actual Start Date" readonly="true" name="wbsasdate" value=''></td>
    </td>
     <td>
      <td><label class="form-Label" style=" ">Actual End Date: </label>  </td>
      <td> <input type="text" class="form-text-box" id="datepicker3" maxlength="25" style="cursor: pointer;width: 102% " placeholder="Select Actual End Date" name="wbsaedate" readonly="true" value=''> </td>
    </td>
  </tr>
    <tr>
    <td>
      <td> <label class="form-Label" style=" ">Estimate Effort:   </label> </td>
      <td>  
       <div style="float:left;width:46%; ">
                      <input type="number" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" placeholder="Enter Effort" class="form-text-box" style=" " name="wbseffort" id="wbseffort" maxlength="5" min="0">
                  </div>
                  <div style="float:left;width:49%; ">
                      <select style="display:inline-block" id="wbseffort1" class="form-text-box" name="wbseffort1">
                            <option  disabled selected value=0>Select</option>
                            <option value=1>Man-Hours</option>
                            <option value=2>Man-Days</option>
                            <option value=3>Man-Weeks</option>
                            <option value=4>Man-Months</option>
                       </select>
                  </div> 
                  </td>
    </td>
    <td>
      <td> <label class="form-Label" style=" ">Type:   </label></td>
      <td>
            <select style="display:inline-block; " id="typeValue" class="form-text-box" name="typeValue">
                <option disabled selected  value=0>Select</option>
                <option value=1>Fixed</option>
                <option value=2>Time & Expence</option>
                </select></td>
    </td>
    <td>
      <td><label style=" " class="form-Label">Assign to All:   </label> </td>
      <td> <select style=" width:103%" id="assign" class="form-text-box" name="assign">
                <option disabled selected  value=0>Select</option>
                <option value=1>Yes</option>
                <option value=2 selected="true">No</option>
              </select></td>
    </td>
    <td>
      <td></td>
      <td> 
       <div class="col-md-2 hide">
          <label class="form-Label" style=" ">WBS Status: <sup>*</sup></label>  
      </div>
      <div class="col-md-4 hide" style=" ">
        <input type="text" name="wbsstatus" class="hide" value=1 id="wbsstatus1" selected style=" "> Active
        <input type="radio" name="wbsstatus" value=0 id="wbsstatus2" style=" "> Inactive
      </div> </td>
    </td>
  </tr>
  <tr>
    <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td> <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
  </tr>
</table>

 <div class="row" id="wbssubmit" style="text-align: center;">
     <a href="/projectDetails">
        <input type="button" name="cancel" value="Cancel" form="cancelform" class="btn  " style="background-color: #f05f40 !important">
      </a> 

    <input type="reset" value="Reset" name="reset" class="btn  " style="background-color: #f05f40 !important;">
    <input type="submit" value="Submit" onclick="return checkfield();" name="submit" class="btn btn-primary" style="background-color: #f05f40 !important;">
    </div>
</div>
<!-- </form> -->
 



 <div id="assignmentDiv" class="hide">
  
  <form id="addassignform"  method="post" onsubmit="" name="client" >
                          <input type="hidden" name="flag" id="hid">
                            <input type="hidden" name="ascode" id="ascodeid" value=''> 

                            <input type="hidden" name="pid" id="pid" value=''> 

                            <input type="hidden" name="retailer" id="retailer" value=''> 

                            <input type="hidden" name="wid" id="wid" value=''> 
   <span class="modal-title" style="padding-left: 44%;padding-bottom: 1%">Create Assingment</span>  
    <input type="hidden" value=""id='pcount'name='pcount'> 
    <table class="table">
  <tr>
    
    <td>
      <td><label class="form-label" style="margin-top: 2%;">User:<sup class="astrick">*</sup></label></td>
      <td id="asdDiv">
       <select class="form-text-box" name="asd" id="asd" multiple="multiple"style="height:300px !important"> 
       
       </select>
        </td>
    </td>
    <td>
      <td  class="hide" ><label class="form-label" style="margin-top:8px">Status:</label></td>
      <td class="hide">
       <div class="radio" id="rad">
              <input type="hidden" id="act" >
                <label style="margin-right:9px"><input type="radio" style="margin-top:0px"   name="astatus" id="active" value='1' checked >Active</label>
                <label><input type="radio" style="margin-top:0px" name="astatus" id="inactive" value='0' >InActive</label> 
              </div>
        </td>
    </td>

    <td>
      <td><label class="form-label">Start Date:<sup class="astrick">*</sup></label></td>
      <td>
         <input type="text"  name="Edate" class="form-text-box datepicker" placeholder="choose a date"  id="datepicker21" style="width: 86%; cursor: pointer; " readonly="true">
           
          
      </td>
    </td>
    <td>
      <td><label class="form-label">End Date:<sup class="astrick">*</sup></label></td>
      <td> 
      <input type="text"  name="Edate" class="form-text-box datepicker" placeholder="choose a date" id="datepicker22" style="width: 86%; cursor: pointer;  " readonly="true">
      </td>
    </td>

  </tr>
 
</table>

   
       <center style="margin-bottom:1%"> 

       <a href="/projectDetails">
          <input type="button" name="cancel" value="Cancel" form="cancelform" class="btn btn-primary" style="background-color: #f05f40 !important">
          </a>

          <input type="button" value="Submit" onclick="submitdata();" name="submit" class="btn btn-primary" style="background-color: #f05f40 !important;">
        

        </center>
        
    </form>
</div>







 <div class="row" id="accordions" style="height:auto; padding:2%">
    <span class="modal-title" style="padding-left:45%;margin-top:1%">Project Details</span>
    <table id="projTable" class="table">
    <thead>
      <th>Project Name</th>
      <th>Project Code</th>
      <th>Complexity</th>
      <th>Location</th>
    </thead>
      <tr>
        <td>
          <%=project[0].projectTitle%> 
        </td>
        <td>
          <%=project[0].pcode%> 
        </td>
        <td>
           <%=project[0].pcomplexity%> 
        </td>
        <td>
          <%=project[0].location%> 
        </td>
      </tr>
    </table>
 <% if(wbs.length >0){ %>  
                <span class="modal-title" style="padding-left:45%;margin-top:1%">WBS Details</span> 
                <div style="overflow-y:scroll; max-height:200px;">
                    <table class="table stripe cell-border hover" id="wbsTable" width=""> 
                        <thead> 
                            <tr> 
                                <th>WBS Name</th>
                                <th>WBS Code</th>
                                <th>WBS Owner</th>
                                <th>WBS Location</th>
                            </tr>
                        </thead>

                        <tbody id="wbsstatus11" style="background-color: white;">
                            <% for(var i=wbs.length-1;i>=0;i--) { console.log('gdgdrfgdsfrfgdsfsfsf---',i) %>
                                <tr id="">

                                    <td>
                                        <%=wbs[i].WBSName%>
                                    </td>
                                    <td>
                                        <%=wbs[i].WBSCode%>
                                    </td>
                                    <td>
                                        <%=wbs[i].firstName%>
                                    </td>
                                    <td>
                                        <%=wbs[i].location%>
                                    </td>

                                </tr>
                                <% } %>
                        </tbody>
                    </table>
                </div>
                <%}%>

</div>
















 </div>
    <footer>
        <% include ./partials/footer %>
    </footer> 
</body> 
<style>
    sup {
        color: red;
    }
    
    label {
        color: black;
    }
    
/*    .tagger {
        border: -1px steelblue !important;
        background-color: #fff !important;
        cursor: text;
        font-family: sans-serif;
        font-size: 10pt !important;
        padding: 10px 7px 3px 4px !important;
        min-height: 19px !important;
        display: table-cell !important;
    }*/
    
    .wbsowner {
        margin-top: 10px;
    }
    
    .wbslocation {
        margin-top: 7px;
    }
</style>



    <script type="text/javascript">
        $(document).ready(function() {

            $('#datepicker').click(function() {
                if ($('#proname').val() < 1) {
                    alert("Please select a project first.");
                }
            });
            $('#datepicker1').click(function() {
                if ($('#proname').val() < 1) {
                    alert("Please select a project first.");
                }
            });


            $("#wbsowner").tagger({
              "fieldWidth":"12em"
            });
            $("#wbslocation").tagger({
              "fieldWidth":"12em"
            });

            $('#wbsstatus1').prop('checked', true);
            /*   $("input[name=pstatus][value=" + 1 + "]").prop('checked', true);*/
            $('.project-img').addClass('active');
            /*
               $("#plocation").prop("selectedIndex", -1);
              $("#pcomplexity").prop("selectedIndex", -1);
              $('#plocation').val('<%=project[0].plocation%>');
              $('#pcomplexity').val('<%=project[0].pcomplexity%>');*/


            /* $("#datepicker").datepicker();
             $("#datepicker1").datepicker();
             */

            $("#datepicker2").datetimepicker({
                timepicker: false,
                format: 'm/d/y',
                scrollMouse: false,
                scrollInput: false
            });
            $("#datepicker3").datetimepicker({
                timepicker: false,
                format: 'm/d/y',
                scrollMouse: false,
                scrollInput: false
            });


            $('#idpname').val('<%=project[0].projectTitle%>');
            $('#datepicker').val('<%=project[0].plannedStartDate%>');
            $('#datepicker1').val('<%=project[0].plannedEndDate%>');

            var text = $('#datepicker').val();
            var date = new Date(text);
            var text1 = $('#datepicker1').val();
            var date1 = new Date(text1);
            if (text != '' && text1 != '') {
                $("#datepicker").datetimepicker({
                    timepicker: false,
                    minDate: date,
                    maxDate: date1,
                    format: 'm/d/y',
                    scrollMouse: false,
                    scrollInput: false
                });
                $("#datepicker1").datetimepicker({
                    format: 'm/d/y',
                    timepicker: false,
                    minDate: date,
                    maxDate: date1,
                    format: 'm/d/y',
                    scrollMouse: false,
                    scrollInput: false
                });
            } else {
                $("#datepicker").datetimepicker({
                    timepicker: false,
                    format: 'm/d/y',
                    scrollMouse: false,
                    scrollInput: false
                });
                $("#datepicker1").datetimepicker({
                    timepicker: false,
                    format: 'm/d/y',
                    scrollMouse: false,
                    scrollInput: false
                });
            }

            otable=$("#projTable").dataTable({
              'iDisplayLength': 10,
                    "order": [],
                    "bFilter": false,"bInfo": false,"bLengthChange": false});
       
        ostable = $('#wbsTable').dataTable({
                    'iDisplayLength': 10,
                    "order": [],
                    "bFilter": false,"bInfo": false,"bLengthChange": false
                });

        $("#asd").tagger({
  'fieldWidth':"18em"
});

});
        function allWbs() {
            var abc = 1;

            <%if(allWbs.length>0){%>
            <%  for(var j=0;j< allWbs.length; j++){%>
            if ($('#wbsname').val() == '<%=allWbs[j].WBSName%>') {
                alert('WBS Already Exists.\nChange the name of WBS');
                abc = 0;
                document.getElementById('wbsname').value = "";
                document.getElementById('wbscode').value = "";
                $('#wbsname').focus();
                return false;
            } else {
                abc++;
            }

            <% } } %>
            if (abc != 0) {
                myFunction();
                return true;
            }

        }

        var y = Math.floor((Math.random() * 1000) + 1);

        function myFunction() {
            var x = document.getElementById("wbsname");
            var x2 = document.getElementById("wbscode");
            if (x.value != '') {
                var ss = x.value;
                ss = ss.charAt(0);
                var s1 = x.value;
                s1 = s1.charAt(1);
                ss = "".concat(ss, s1);

                x2.value = ss + "_" + y;
            } else {
                x2.value = "";
            }
        }

        function checkfield() {

            if ($('#wbsname').val().trim().length <= 0 || $('#wbsname').val() == '') {
                alert("Please Enter WBS Name First");
                return false;
            }

            if ($('#proname').val() == 0) {
                alert("Please select a Project Id First");
                return false;
            }
            if ($('#wbsowner').val() == '') {
                alert("Please select a WBS Owner First");
                return false;
            }


            var text = $('#datepicker').val();
            var date = new Date(text);
            if (date == 'Invalid Date') {
                alert('Invalid  Planned Start Date');
                return false;
            }
            var text = $('#datepicker1').val();
            var date = new Date(text);
            if (date == 'Invalid Date') {
                alert('Invalid  Planned End Date');
                return false;
            }
            var text = $('#datepicker2').val();
            var date = new Date(text);
            if (text != '') {
                if (date == 'Invalid Date') {
                    alert('Invalid  Actual Start Date');
                    return false;
                }
            }
            var text = $('#datepicker3').val();
            var date = new Date(text);
            if (text != '') {
                if (date == 'Invalid Date') {
                    alert('Invalid  Actual End Date');
                    return false;
                }
            }

            /*var sdate = $('#datepicker').datetimepicker("getDate");*/
            var text = $('#datepicker').val();
            /*var edate = $('#datepicker1').datetimepicker("getDate");*/
            var text1 = $('#datepicker1').val();
            /*var asdate = $('#datepicker2').datetimepicker("getDate");*/
            var text2 = $('#datepicker2').val();
            /*var aedate = $('#datepicker3').datetimepicker("getDate");*/
            var text3 = $('#datepicker3').val();
            var sdate = new Date(text);
            var edate = new Date(text1);
            var asdate = new Date(text2);
            var aedate = new Date(text3);

            /*if(text1 != ''){ if (text != ''){
            if(sdate>edate){
              alert('Planned End Date can not be less than Planned Start Date');
               return false;
            }  }
            else{
              alert('Please Select Planned Start Date');
               return false;
            }
          }*/

            if (text == '') {
                alert('Please Select Planned Start Date');
                return false;
            }
            if (text1 == '') {
                alert('Please Select Planned End Date');
                return false;
            }
            if (sdate > edate) {
                alert('Planned End Date can not be less than Planned Start Date');
                return false;
            }


            if (text3 != '') {
                if (text2 != '') {
                    if (asdate > aedate) {
                        alert('Actual End Date can not be less than Actual Start Date');
                        return false;
                    }
                } else {
                    alert('Please Select Actual Start Date');
                    return false;
                }
            }

            var radios = document.getElementsByName("wbsstatus");
            var len = radios.length;
            var chosen = null;

            for (i = 0; i < len; i++) {
                if (radios[i].checked) {
                    chosen = radios[i].value;
                }
            }

            if (chosen == null) {
                alert("Please select a WBS Status");
                return false;
            }



            /*if (! $.isNumeric( $("#wbseffort").val() ) ) {
                   alert('WBS Effort field should have a numeric value.');
                  return false;
              }*/


            var wbseffort = $('#wbseffort').val();
            var wbseffort1 = $('#wbseffort1').val();
            if (wbseffort != '') {

                if (wbseffort1 == 0) {
                    alert('Please Select WBS Effort Type');
                    return false;
                }
            }
            /*var wbsType = $('#wbsType').val();
            var typeValue = $('#typeValue').val();*/
      /*      if (wbsType != '') {
                if (typeValue == 0) {
                    alert('Please Select Type');
                    return false;
                }
            }*/
            submitwbs();
        }

        function submitwbs() {
            alert('WBS added successfully'); 

            $('#wbshidden').val(13);
            $.ajax({
                url: '/addEditWbsDetails',
                type: 'post',
                data: {"wbshidden":$('#wbshidden').val(),"assign":$('#assign').val(),"flaghide":$('#flaghide').val(),"wbsidhide":$('#idhide').val(),"wbsname":$('#wbsname').val(),"wbscode":$('#wbscode').val(),"proname":$('#proname').val(), "wbsowner":$('#wbsowner').val(),"wbspsdate":$('#datepicker').val(),"wbspedate":$('#datepicker1').val(),"wbsasdate":$('#datepicker2').val(),"wbsaedate":$('#datepicker3').val(),"wbsstatus":$('#wbsstatus1').val(),"wbseffort":$('#wbseffort').val(),"wbseffort1":$('#wbseffort1').val(),"wbslocation":$('#wbslocation').val(),"typeValue":$('#typeValue').val()},
                success: function(data) {

                  console.log(data[0]);
                  console.log(data[1]);
                  console.log(data[2]);
                  console.log(data[3]);

                  $('#retailer').val(data[1][0].retailer);
                  
                  if(confirm("Do you want to create Assignment for WBS - "+$('#wbsname').val()+" ?") ){
                        $('#wbssubmit').addClass('hide');
                        $('#pid').val(data[1][0].pid);
                        $('#wid').val(data[1][0].wid);
                        $('#asd').html('');
                        //console.log('user---',data[2])
                          var string1="<select multiple='multiple' id=\"asd\"><option disabled value=0>Select</option>" ;
                           for (var i = 0; i < data[2].length; i++){ // alert(data[2][i].id+' '+data[2][i].firstName) ;
                                string1+="<option value="+data[2][i].id+">"+data[2][i].firstName+"</option>"  ;           
                                }
                          string1+="</select>";
                          console.log(string1);
                          $("#asdDiv").html(string1);
                          
                           $('#asd').tagger({
                            "fieldWidth":"18em"
                              }); 

                          var date=new Date(data[3][0].wplannedStartDate);
                          var date1=new Date(data[3][0].wplannedEndDate);


                          $("#datepicker21").datetimepicker({
                                       timepicker:false,
                                       format:"m/d/y",
                                       scrollMouse: false,
                                       scrollInput: false,minDate:date,maxDate:date1
                          });

                          $("#datepicker22").datetimepicker({
                                       timepicker:false,
                                       format:"m/d/y",
                                       scrollMouse: false,
                                       scrollInput: false,minDate:date,maxDate:date1
                          });


                          $('#assignmentDiv').removeClass('hide');
                      }
                      else{
                         var r = confirm("Do you want to create more WBS ?"); 
                        if (r == false) {  
                            window.location.href="/projectDetails";
                            
                        }
                        else{
                          window.location.href="/projectWbs?pid="+$('#proname').val();
                        }
                      }

                }

            });


            return false;
        }

        function specialCharacter(evt) {
            var charCode = (evt.which) ? evt.which : event.keyCode
                /*if ( !(charCode > 47 && charCode < 58) || !(charCode > 64 && charCode < 91) || !(charCode == 96 || charCode == 123) ) {*/
            if ((charCode != 38 && charCode > 32 && charCode < 46) || (charCode > 57 && charCode < 64) || charCode == 126 || charCode == 96) {
                alert("This special character or number is not allowed\n ");
                return false;
            }
            return true;
        }








        function submitdata(){


          var alluser=[];
    var startDt=document.getElementById("datepicker21").value;
var endDt=document.getElementById("datepicker22").value;


    var s = document.getElementById("asd");
  //  alert("length of s is"+s.options.length);
    for (var i = 0; i < s.options.length; i++) {
         if (s.options[i].selected == true) {
           var user = s.options[i].value;
           alluser.push(user);
           
         }
        
    } 

       if($('#datepicker21').val()==null)
     { alert("Please select a StartDate"); 
      return false;  }
     if($('#datepicker22').val()==null)
     { alert("Please select a EndDate"); 
      return false;  }

    var r = document.getElementsByName("astatus")
    var c = -1;
    for(var i=0; i < r.length; i++){
     if(r[i].checked) {
      c = i; 
                     }
        }
   if (c == -1)
    { alert("please select status"); 
     return false;}


       if($('#asd').val()==null)
     { alert("Please select Users"); 
      return false;  }

      var psdate = $('#datepicker').datepicker("getDate"); var text = $('#datepicker21').val();
            var pedate = $('#datepicker1').datepicker("getDate");var text1 = $('#datepicker22').val();
          
            if(text != '')
            { 
              if (text1 != '')
              {
                    if(text>text1){
                        alert('Assignment End Date can not be less than Assignment Start Date');
                        return false;
                                   }
              }
            else
            {
              alert('Please Select Assignment End Date');
               return false;
            }
           }
          else
          {
            alert('Please Select Assignment Start Date');
            return false;
          }
          if(text1==''){
              alert('Please Select Assignment End Date');
              return false;
            }
    console.log("----------------------------------");  
    

var td= new Date();
  var dd=td.getDate();
  var mm=td.getMonth();
  mm=mm+1;
  var yr=td.getFullYear();
  st_ed_date=mm+"/"+dd+"/"+yr;

     $.ajax({        
                         url:'/submitAssignment',
                    type:'post',
                    data:{
                      "flag":0,
                      "assignmentId":0,
                      "procode":$('#pid').val(),
                      "wbs":$('#wid').val(),
                      "user":alluser.toString(),
                      "status":$("input[type='radio'][name='astatus']:checked").val(),
                      "asdate":$('#datepicker21').val(),
                      "aedate":$('#datepicker22').val(),
                        "curdat":st_ed_date,
                      "retailerid":$('#retailer').val()
                    },

                  success:function(data){

                      alert('Assignment Added Successfully');

                            var r = confirm("Do you want to create more WBS ?"); 
                        if (r == false) {  
                            window.location.href="/projectDetails";
                            
                        }
                        else{
                          window.location.href="/projectWbs?pid="+$('#proname').val();
                        }
                    }
                  });
}






    </script>